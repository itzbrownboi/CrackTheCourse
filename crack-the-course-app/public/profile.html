<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/profile.css">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">

</head>

<body>
    <div class="min-h-screen bg-gray-50">
        <!-- Desktop View -->
        <div class="desktop-view">
            <!-- Sidebar -->
            <div class="left-part">
                <div>
                    <img class="logo" src="images/logo.jpeg" alt="App logo">
                </div>
                <div>
                    <div class="home" id="nav-home">
                        <img class="home-logo" src="images/home-black.png" alt="Home logo">
                        <a href="home.html" class="logo-text">Homepage</a>
                    </div>
                    <div class="student" id="nav-mytutors" onclick="window.location.href='mytutors.html'">
                        <img class="student-logo" src="images/tutor.jpg" alt="Tutor logo">
                        <a href="mytutors.html" class="logo-text" id="nav-mytutors-link">My Tutors</a>
                    </div>
                    <div class="chat" id="nav-chat" onclick="window.location.href='chat.html'">
                        <img class="chat-logo" src="images/chat.png" alt="Chat logo">
                        <a href="chat.html" class="logo-text">Messages</a>
                    </div>
                </div>
                <div class="person" id="nav-profile" onclick="window.location.href='profile.html'">
                    <img class="person-logo" src="images/person.png" alt="Person logo">
                    <a href="profile.html" class="logo-text" id="nav-profile-link">My Profile</a>
                </div>
            </div>
            <div class="divider"></div>

            <!-- Main Content -->
            <div class="main-content">
                <div class="content-container">
                    <div class="edit-button">
                        <i data-lucide="edit-2"></i>
                    </div>

                    <!-- Edit Button -->
                    <div class="edit-profile-button">
                        <img src="images/edit-profile.png" alt="Edit Profile" class="open-edit-modal" />
                    </div>

                    <!-- Profile Section -->
                    <div class="profile-section">
                        <img src="images/profile.png" alt="Profile" class="profile-image">
                        <h1 class="profile-name" id="profile-name">Stu Dent</h1>
                        <p class="profile-info" id="profile-info">3rd Year Computer Science Major</p>
                        <p class="profile-info" id="university-info">University of Calgary</p>
                    </div>

                    <!-- Conditional Course Section -->
                    <div class="courses-grid" id="courses-section">
                        <div class="course-section" id="student-courses-strong">
                            <h2>Strong Courses</h2>
                            <div class="course-list">
                                <p>MATH 265, CPSC 233, CPSC 251</p>
                            </div>
                        </div>
                        <div class="course-section" id="student-courses-weak">
                            <h2>Weak Courses</h2>
                            <div class="course-list">
                                <p>CPSC 355, SENG 513, MATH 211</p>
                            </div>
                        </div>
                        <div class="course-section" id="tutor-courses">
                            <h2>Courses I Teach</h2>
                            <div class="course-list">
                                <p>CPSC 233, CPSC 251, MATH 265</p>
                            </div>
                        </div>
                    </div>
                    <button id="sign-out-button" class="sign-out-button">Sign Out</button>




                    <!-- Activity Section -->
                    <!-- <div class="activity-section">
                        <h2>Activity</h2>
                        <div class="activity-list">
                            <div class="activity-item">
                                <i data-lucide="edit-2"></i>
                                <span>Created Account</span>
                            </div>
                            <div class="activity-item">
                                <i data-lucide="edit-2"></i>
                                <span>Updated Courses</span>
                            </div>
                        </div>
                    </div> -->
                </div>
            </div>
        </div>

        <!-- Mobile View -->
        <div class="mobile-view">
            <div class="mobile-content">
                <div class="edit-button">
                    <i data-lucide="edit-2"></i>
                </div>

                <!-- Edit Button -->
                <div class="edit-profile-button">
                    <img src="images/edit-profile.png" alt="Edit Profile" class="open-edit-modal" />
                </div>

                <!-- Profile Section -->
                <div class="profile-section">
                    <img src="images/profile.png" alt="Profile" class="profile-image">
                    <h1 class="profile-name" id="profile-name-mobile">Stu Dent</h1>
                    <p class="profile-info" id="profile-info-mobile">3rd Year Computer Science Major</p>
                    <p class="profile-info" id="university-info-mobile">University of Calgary</p>
                </div>

                <!-- Conditional Mobile Course Section -->
                <div class="mobile-courses" id="mobile-courses-section">
                    <div class="course-section" id="student-courses-mobile-strong">
                        <h2>Strong Courses</h2>
                        <div class="course-list">
                            <p>CPSC 355, SENG 513, MATH 211</p>
                        </div>
                    </div>
                    <div class="course-section" id="student-courses-mobile-weak">
                        <h2>Weak Courses</h2>
                        <div class="course-list">
                            <p>CPSC 355, SENG 513, MATH 211</p>
                        </div>
                    </div>
                    <div class="course-section" id="tutor-courses-mobile">
                        <h2>Courses I Teach</h2>
                        <div class="course-list">
                            <p>CPSC 233, CPSC 251</p>
                        </div>
                    </div>
                </div>
                <button id="sign-out-button-mobile" class="sign-out-button">Sign Out</button>

                <!-- Activity Section -->
                <!-- <div class="activity-section">
                    <h2>Activity</h2>
                    <div class="activity-list">
                        <div class="activity-item">
                            <i data-lucide="edit-2"></i>
                            <span>Sent Request to Omar</span>
                        </div>
                        <div class="activity-item">
                            <i data-lucide="edit-2"></i>
                            <span>Tutoring with Tina</span>
                        </div>
                    </div>
                </div> -->
            </div>

            <!-- Mobile Navigation -->
            <div class="mobile-nav">
                <a href="home.html" class="mobile-nav-item active" id="mobile-nav-home">
                    <img src="images/home-black.png" alt="Home" class="nav-icon">
                    <span>Home</span>
                </a>
                <a href="mytutors.html" class="mobile-nav-item" id="mobile-nav-mytutors">
                    <img src="images/tutor.jpg" alt="My Tutors" class="nav-icon">
                    <span id="mobile-nav-mytutors-link">My Tutors</span>
                </a>
                <a href="chat.html" class="mobile-nav-item" id="mobile-nav-chat">
                    <img src="images/chat.png" alt="Messages" class="nav-icon">
                    <span>Messages</span>
                </a>
                <a href="profile.html" class="mobile-nav-item" id="mobile-nav-profile">
                    <img src="images/person.png" alt="Profile" class="nav-icon">
                    <span>Profile</span>
                </a>
            </div>
        </div>
    </div>

    <script>
        // Retrieve the email from localStorage
        const userEmail = localStorage.getItem('userEmail');
        function hideNavSection(idSuffix) {
            const nav = document.getElementById(`nav-${idSuffix}`);
            const mobileNav = document.getElementById(`mobile-nav-${idSuffix}`);
            if (nav) nav.style.display = "none";
            if (mobileNav) mobileNav.style.display = "none";
        }

        // Fetch profile data based on email
        if (userEmail) {
            fetch(`/api/profile?email=${userEmail}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error(data.error);
                        return;
                    }

                    window.currentProfileData = data;
                    const role = data.role;

                    // Update the profile information based on the returned data
                    const profileName = document.getElementById('profile-name');
                    const profileInfo = document.getElementById('profile-info');
                    const coursesSection = document.getElementById('courses-section');
                    const studentCoursesStrong = document.getElementById('student-courses-strong');
                    const studentCoursesWeak = document.getElementById('student-courses-weak');
                    const tutorCourses = document.getElementById('tutor-courses');
                    const studentCoursesMobileStrong = document.getElementById('student-courses-mobile-strong');
                    const studentCoursesMobileWeak = document.getElementById('student-courses-mobile-weak');
                    const tutorCoursesMobile = document.getElementById('tutor-courses-mobile');

                    profileName.textContent = `${data.firstName} ${data.lastName}`;
                    document.getElementById('profile-name-mobile').textContent = `${data.firstName} ${data.lastName}`;
                    document.getElementById('profile-info-mobile').textContent = data.educationLevel;
                    profileInfo.textContent = data.educationLevel;
                    console.log(data.role);
                    if (data.role === 'tutor') {

                        studentCoursesStrong.style.display = 'none';
                        studentCoursesWeak.style.display = 'none';
                        tutorCourses.style.display = 'block';
                        tutorCourses.innerHTML = `
                            <h2>Courses I Teach</h2>
                            <div class="course-list">
                                <p>${data.profile.teachCourses.join(', ')}</p>
                            </div>
                            `;

                        studentCoursesMobileStrong.style.display = 'none';
                        studentCoursesMobileWeak.style.display = 'none';
                        tutorCoursesMobile.style.display = 'block';

                        tutorCoursesMobile.innerHTML = `
                            <h2>Courses I Teach</h2>
                            <div class="course-list">
                                <p>${data.profile.teachCourses.join(', ')}</p>
                            </div>
                            `;
                        // remove homepage for tutor
                        hideNavSection("home");

                    } else if (data.role === 'student') {
                        studentCoursesStrong.style.display = 'block';
                        studentCoursesStrong.innerHTML = `
                                <h2>Strong Courses</h2>
                                <div class="course-list">
                                    <p>${data.profile.strongCourses.join(', ')}</p>
                                </div>
                                `;
                        studentCoursesWeak.style.display = 'block';
                        studentCoursesWeak.innerHTML = `
                                <h2>Weak Courses</h2>
                                <div class="course-list">
                                    <p>${data.profile.weakCourses.join(', ')}</p>
                                </div>
                                `;
                        tutorCourses.style.display = 'none';
                        studentCoursesMobileStrong.style.display = 'block';
                        studentCoursesMobileStrong.innerHTML = `
                                <h2>Strong Courses</h2>
                                <div class="course-list">
                                    <p>${data.profile.strongCourses.join(', ')}</p>
                                </div>`
                        studentCoursesMobileWeak.style.display = 'block';
                        studentCoursesMobileWeak.innerHTML = `
                                <h2>Weak Courses</h2>
                                <div class="course-list">
                                    <p>${data.profile.weakCourses.join(', ')}</p>
                                </div>
                                `;
                        tutorCoursesMobile.style.display = 'none';
                    } else if (data.role === 'admin') {
                        document.getElementById('nav-mytutors-link').href = 'admintutors.html';
                        document.getElementById('nav-mytutors-link').textContent = "Manage Tutors";
                        document.getElementById('mobile-nav-mytutors-link').textContent = "Manage Tutors";
                        document.getElementById('mobile-nav-mytutors').href = 'admintutors.html';
                        profileInfo.textContent = "Role: Administrator";
                        document.getElementById('university-info').textContent = "Only admins can see this view";
                        studentCoursesStrong.style.display = 'none';
                        studentCoursesWeak.style.display = 'none';
                        tutorCourses.style.display = 'none';
                        studentCoursesMobileStrong.style.display = 'none';
                        studentCoursesMobileWeak.style.display = 'none';
                        tutorCoursesMobile.style.display = 'none';
                        const idSuffixes = ["home", "chat"];
                        idSuffixes.forEach(hideNavSection);

                    }
                })
                .catch(error => {
                    console.error('Error fetching profile data:', error);
                });
        } else {
            console.error("User email not found in localStorage.");
        }

        document.getElementById('sign-out-button').addEventListener('click', () => {
            localStorage.removeItem('userEmail'); // Clear the stored email
            window.location.href = 'welcome.html'; // Redirect to welcome page
        });

        document.getElementById('sign-out-button-mobile').addEventListener('click', () => {
            localStorage.removeItem('userEmail'); // Clear the stored email
            window.location.href = 'welcome.html'; // Redirect to welcome page
        });



    </script>

    <!-- Edit Profile Modal -->
    <div id="editProfileModal" class="modal hidden">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2>Edit Profile</h2>
            <form id="editProfileForm">
                <div class="form-group">
                    <label for="edit-firstname">First Name:</label>
                    <input type="text" id="edit-firstname" placeholder="First Name" />
                </div>

                <div class="form-group">
                    <label for="edit-lastname">Last Name:</label>
                    <input type="text" id="edit-lastname" placeholder="Last Name" />
                </div>

                <div class="form-group">
                    <label for="edit-education">Education Level:</label>
                    <input type="text" id="edit-education" placeholder="e.g. Undergraduate – 2nd Year" />
                </div>

                <div class="form-group" id="group-strong">
                    <label for="edit-strong">Strong Courses (separate with commas):</label>
                    <input type="text" id="edit-strong" placeholder="e.g. CPSC 233, MATH 211" />
                </div>

                <div class="form-group" id="group-weak">
                    <label for="edit-weak">Weak Courses (separate with commas):</label>
                    <input type="text" id="edit-weak" placeholder="e.g. CPSC 355, MATH 211" />
                </div>

                <div class="form-group" id="group-teach">
                    <label for="edit-teach">Courses You Teach (separate with commas):</label>
                    <input type="text" id="edit-teach" placeholder="e.g. CPSC 233, MATH 211" />
                </div>

                <div class="form-group">
                    <label for="edit-password">Password (leave blank to keep current):</label>
                    <input type="password" id="edit-password" placeholder="••••••••" autocomplete="new-password" />
                </div>

                <button type="submit" class="save-button">Save</button>
            </form>
        </div>
    </div>

    <script>
        const modal = document.getElementById("editProfileModal");
        const closeBtn = document.querySelector(".close-button");
        const openBtns = document.querySelectorAll(".open-edit-modal");

        openBtns.forEach(btn => {
            btn.onclick = () => {
                modal.classList.remove("hidden");

                const data = window.currentProfileData;
                const role = data.role;

                const [firstName, lastName] = data.firstName && data.lastName
                    ? [data.firstName, data.lastName]
                    : (document.getElementById('profile-name').textContent.split(" "));

                document.getElementById("edit-firstname").value = firstName || "";
                document.getElementById("edit-lastname").value = lastName || "";
                document.getElementById("edit-education").value = data.educationLevel || "";

                // Hide all groups first
                document.getElementById("group-strong").style.display = "none";
                document.getElementById("group-weak").style.display = "none";
                document.getElementById("group-teach").style.display = "none";

                if (role === "student") {
                    document.getElementById("group-strong").style.display = "block";
                    document.getElementById("group-weak").style.display = "block";
                    document.getElementById("edit-strong").value = data.profile?.strongCourses?.join(", ") || "";
                    document.getElementById("edit-weak").value = data.profile?.weakCourses?.join(", ") || "";
                } else if (role === "tutor") {
                    document.getElementById("group-teach").style.display = "block";
                    document.getElementById("edit-teach").value = data.profile?.teachCourses?.join(", ") || "";
                }
            };
        });

        closeBtn.onclick = () => {
            modal.classList.add("hidden");
        };

        // Submit form
        document.getElementById("editProfileForm").addEventListener("submit", async (e) => {
            e.preventDefault();

            const passwordInput = document.getElementById("edit-password").value.trim();

            let profile = {};

            if (window.currentProfileData.role === "student") {
                profile.strongCourses = document.getElementById("edit-strong").value.split(",").map(c => c.trim());
                profile.weakCourses = document.getElementById("edit-weak").value.split(",").map(c => c.trim());
            } else if (window.currentProfileData.role === "tutor") {
                profile.teachCourses = document.getElementById("edit-teach").value.split(",").map(c => c.trim());
            }

            const payload = {
                firstName: document.getElementById("edit-firstname").value,
                lastName: document.getElementById("edit-lastname").value,
                educationLevel: document.getElementById("edit-education").value,
                role: window.currentProfileData.role,
                profile
            };

            if (passwordInput !== "") {
                payload.password = passwordInput;
            }

            try {
                const res = await fetch(`/api/profile/update?email=${userEmail}`, {
                    method: "PUT",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(payload)
                });

                const result = await res.json();
                if (res.ok) {
                    alert("Profile updated!");
                    modal.classList.add("hidden");
                    // document.getElementById("edit-password").value = "";
                    location.reload();  // Reload to reflect updates
                } else {
                    alert(result.error || "Failed to update profile.");
                }
            } catch (err) {
                console.error("Update failed", err);
                alert("Something went wrong.");
            }
        });
    </script>


</body>

</html>